<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥é£²é£Ÿè‡ªæˆ‘ç›£æ§ç´€éŒ„è¡¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .client-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .client-info input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .client-info input:focus {
            outline: none;
            border-color: #667eea;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: "ğŸ½ï¸";
            margin-right: 10px;
            font-size: 24px;
        }

        .food-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .food-item {
            position: relative;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .food-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .food-item.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .food-item input[type="checkbox"] {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            cursor: pointer;
            z-index: 10;
        }

        .food-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .food-label {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #333;
            background: white;
        }

        .portion-selector {
            padding: 10px;
            background: #f8f9ff;
            display: none;
        }

        .food-item.selected .portion-selector {
            display: block;
        }

        .portion-selector select {
            width: 100%;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .cooking-selector {
            margin-top: 8px;
        }

        .cooking-selector select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ff9800;
            border-radius: 5px;
            font-size: 14px;
        }

        .custom-input {
            margin-top: 8px;
        }

        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 10px;
            resize: vertical;
            min-height: 80px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #00c853;
            color: white;
        }

        .btn-secondary:hover {
            background: #00a844;
            transform: translateY(-2px);
        }

        .btn-history {
            background: #ff9800;
            color: white;
        }

        .btn-history:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 30px;
            cursor: pointer;
            color: #666;
        }

        .history-item {
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9ff;
        }

        .history-item h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #ffc107;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #856404;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .food-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 25px; border-radius: 50px; font-size: 24px; font-weight: bold; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);">
                    Fit21
                </div>
            </div>
            <h1>ğŸ½ï¸ æ¯æ—¥é£²é£Ÿè‡ªæˆ‘ç›£æ§ç´€éŒ„è¡¨</h1>
            <p style="color: #666; margin-top: 10px;">åˆé¤/å¤–é£Ÿç‰ˆ</p>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨èªªæ˜</h3>
            <ol>
                <li>è«‹å¡«å¯«æ‚¨çš„åŸºæœ¬è³‡æ–™</li>
                <li>é»é¸æ‚¨ä»Šå¤©åƒçš„é£Ÿç‰©(å¯å¤šé¸)</li>
                <li>é¸æ“‡é£Ÿç‰©ä»½é‡</li>
                <li>å®Œæˆå¾Œé»ã€Œç”Ÿæˆç´€éŒ„PDFã€</li>
            </ol>
        </div>

        <div class="client-info">
            <input type="text" id="clientName" placeholder="å§“å" required>
            <input type="date" id="recordDate" required>
            <select id="mealType">
                <option value="åˆé¤">åˆé¤</option>
                <option value="æ™šé¤">æ™šé¤</option>
            </select>
            <select id="locationType">
                <option value="å¤–é£Ÿ">å¤–é£Ÿ</option>
                <option value="è‡ªç…®">è‡ªç…®</option>
            </select>
        </div>

        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸»è¦è›‹ç™½è³ªä¾†æº -->
        <div class="section">
            <div class="section-title">ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸»è¦è›‹ç™½è³ªä¾†æº</div>
            <div class="food-grid" id="proteinSection">
                <!-- è›‹ç™½è³ªé¸é … -->
            </div>
        </div>

        <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šç¢³æ°´åŒ–åˆç‰© -->
        <div class="section">
            <div class="section-title">ç¬¬äºŒéƒ¨åˆ†ï¼šç¢³æ°´åŒ–åˆç‰©</div>
            <div class="food-grid" id="carbsSection">
                <!-- ç¢³æ°´é¸é … -->
            </div>
        </div>

        <!-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šè”¬èœæ”å– -->
        <div class="section">
            <div class="section-title">ç¬¬ä¸‰éƒ¨åˆ†ï¼šè”¬èœæ”å–</div>
            <div class="food-grid" id="veggiesSection">
                <!-- è”¬èœé¸é … -->
            </div>
        </div>

        <!-- ç¬¬å››éƒ¨åˆ†ï¼šæ°´æœç´€éŒ„ -->
        <div class="section">
            <div class="section-title">ç¬¬å››éƒ¨åˆ†ï¼šæ°´æœç´€éŒ„</div>
            <div class="food-grid" id="fruitSection">
                <!-- æ°´æœé¸é … -->
            </div>
        </div>

        <!-- å‚™è¨» -->
        <div class="section">
            <div class="section-title">ğŸ’­ å‚™è¨»</div>
            <textarea id="notes" class="text-input" placeholder="å…¶ä»–æƒ³è¨˜éŒ„çš„äº‹é …..."></textarea>
        </div>

        <div class="button-group">
            <button class="btn btn-history" onclick="showHistory()">
                ğŸ“š æŸ¥çœ‹ç´€éŒ„
            </button>
            <button class="btn btn-primary" onclick="generatePDF()">
                ğŸ“„ ç”Ÿæˆç´€éŒ„PDF
            </button>
            <button class="btn btn-secondary" onclick="shareToLine()">
                ğŸ’¬ åˆ†äº«åˆ°Line
            </button>
        </div>
    </div>

    <!-- æ­·å²ç´€éŒ„ Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeHistory()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“š æˆ‘çš„é£²é£Ÿç´€éŒ„</h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // é£Ÿç‰©è³‡æ–™åº«
        const foodDatabase = {
            protein: [
                {name: 'è±¬è‚‰', emoji: 'ğŸ¥“', portions: ['é›è›‹å¤§å°', 'æ’²å…‹ç‰Œå¤§å°', 'æ‰‹æŒå¤§å°'], cooking: ['æ¸…è’¸/æ°´ç…®', 'ç‚’(å°‘æ²¹)', 'ç‚’(å¤šæ²¹)', 'æ²¹ç‚¸', 'æ»·/ç‡‰', 'çƒ¤', 'ç…']},
                {name: 'é›è‚‰', emoji: 'ğŸ—', portions: ['é›è›‹å¤§å°', 'æ’²å…‹ç‰Œå¤§å°', 'æ‰‹æŒå¤§å°'], cooking: ['æ¸…è’¸/æ°´ç…®', 'ç‚’(å°‘æ²¹)', 'ç‚’(å¤šæ²¹)', 'æ²¹ç‚¸', 'æ»·/ç‡‰', 'çƒ¤', 'ç…']},
                {name: 'ç‰›è‚‰', emoji: 'ğŸ¥©', portions: ['é›è›‹å¤§å°', 'æ’²å…‹ç‰Œå¤§å°', 'æ‰‹æŒå¤§å°'], cooking: ['æ¸…è’¸/æ°´ç…®', 'ç‚’(å°‘æ²¹)', 'ç‚’(å¤šæ²¹)', 'æ²¹ç‚¸', 'æ»·/ç‡‰', 'çƒ¤', 'ç…']},
                {name: 'é­šè‚‰', emoji: 'ğŸŸ', portions: ['é›è›‹å¤§å°', 'æ’²å…‹ç‰Œå¤§å°', 'æ‰‹æŒå¤§å°'], cooking: ['æ¸…è’¸/æ°´ç…®', 'ç‚’(å°‘æ²¹)', 'ç‚’(å¤šæ²¹)', 'æ²¹ç‚¸', 'æ»·/ç‡‰', 'çƒ¤', 'ç…']},
                {name: 'è›‹', emoji: 'ğŸ¥š', portions: ['1é¡†', '2é¡†', '3é¡†'], cooking: ['æ°´ç…®è›‹', 'è’¸è›‹', 'ç‚’è›‹(å°‘æ²¹)', 'ç‚’è›‹(å¤šæ²¹)', 'ç…è›‹(å°‘æ²¹)', 'ç…è›‹(å¤šæ²¹)', 'æ»·è›‹', 'èŒ¶è‘‰è›‹']},
                {name: 'è±†è…', emoji: 'ğŸ§ˆ', portions: ['åŠç›’', '1ç›’', '1.5ç›’'], cooking: ['æ¸…è’¸', 'æ°´ç…®/æ¹¯', 'ç‚’(å°‘æ²¹)', 'ç‚’(å¤šæ²¹)', 'æ²¹ç‚¸', 'æ»·', 'æ¶¼æ‹Œ']},
                {name: 'æµ·é®®', emoji: 'ğŸ¦', portions: ['é›è›‹å¤§å°', 'æ’²å…‹ç‰Œå¤§å°', 'æ‰‹æŒå¤§å°'], cooking: ['æ¸…è’¸/æ°´ç…®', 'ç‚’(å°‘æ²¹)', 'ç‚’(å¤šæ²¹)', 'æ²¹ç‚¸', 'æ»·/ç‡‰', 'çƒ¤', 'ç…']},
                {name: 'å…¶ä»–', emoji: 'ğŸ–', portions: ['é›è›‹å¤§å°', 'æ’²å…‹ç‰Œå¤§å°', 'æ‰‹æŒå¤§å°'], cooking: ['æ¸…è’¸/æ°´ç…®', 'ç‚’(å°‘æ²¹)', 'ç‚’(å¤šæ²¹)', 'æ²¹ç‚¸', 'æ»·/ç‡‰', 'çƒ¤', 'ç…'], needsCustom: true, needsNote: true}
            ],
            carbs: [
                {name: 'ç™½é£¯', emoji: 'ğŸš', portions: ['1/4ç¢—', '1/2ç¢—', '3/4ç¢—', '1ç¢—', '>1ç¢—']},
                {name: 'ç³™ç±³é£¯', emoji: 'ğŸ™', portions: ['1/4ç¢—', '1/2ç¢—', '3/4ç¢—', '1ç¢—', '>1ç¢—']},
                {name: 'éºµæ¢', emoji: 'ğŸ', portions: ['1/4ç¢—', '1/2ç¢—', '3/4ç¢—', '1ç¢—', '>1ç¢—']},
                {name: 'éºµåŒ…', emoji: 'ğŸ', portions: ['1ç‰‡', '2ç‰‡', '3ç‰‡']},
                {name: 'åœ°ç“œ', emoji: 'ğŸ ', portions: ['åŠå€‹æ‹³é ­', '1å€‹æ‹³é ­', '1.5å€‹æ‹³é ­']},
                {name: 'é¦¬éˆ´è–¯', emoji: 'ğŸ¥”', portions: ['åŠå€‹æ‹³é ­', '1å€‹æ‹³é ­', '1.5å€‹æ‹³é ­']},
                {name: 'å…¶ä»–', emoji: 'ğŸ¥Ÿ', needsCustom: true, needsQuantity: true}
            ],
            veggies: [
                {name: 'æ·±ç¶ è‰²è”¬èœ(ç†Ÿ)', emoji: 'ğŸ¥¬', portions: ['å°‘æ–¼1/2ç¢—', 'ç´„1/2ç¢—', 'ç´„1ç¢—', 'è¶…é1ç¢—']},
                {name: 'æ·ºè‰²è”¬èœ(ç†Ÿ)', emoji: 'ğŸ¥—', portions: ['å°‘æ–¼1/2ç¢—', 'ç´„1/2ç¢—', 'ç´„1ç¢—', 'è¶…é1ç¢—']},
                {name: 'è‡é¡(ç†Ÿ)', emoji: 'ğŸ„', portions: ['å°‘æ–¼1/2ç¢—', 'ç´„1/2ç¢—', 'ç´„1ç¢—', 'è¶…é1ç¢—']},
                {name: 'è±†è¢é¡(ç†Ÿ)', emoji: 'ğŸ«›', portions: ['å°‘æ–¼1/2ç¢—', 'ç´„1/2ç¢—', 'ç´„1ç¢—', 'è¶…é1ç¢—']},
                {name: 'ç”Ÿèœæ²™æ‹‰', emoji: 'ğŸ¥—', portions: ['1å€‹æ‰‹æŒ', '2å€‹æ‰‹æŒ', '3å€‹æ‰‹æŒ', '4å€‹æ‰‹æŒ']}
            ],
            fruit: [
                {name: 'è˜‹æœ', emoji: 'ğŸ', portions: ['å°æ–¼æ‹³é ­', 'ç´„æ‹³é ­å¤§', 'å¤§æ–¼æ‹³é ­']},
                {name: 'é¦™è•‰', emoji: 'ğŸŒ', portions: ['åŠæ ¹', '1æ ¹', '2æ ¹']},
                {name: 'æŸ³æ©™', emoji: 'ğŸŠ', portions: ['å°æ–¼æ‹³é ­', 'ç´„æ‹³é ­å¤§', 'å¤§æ–¼æ‹³é ­']},
                {name: 'è‘¡è„', emoji: 'ğŸ‡', portions: ['å°æ–¼æ‹³é ­', 'ç´„æ‹³é ­å¤§', 'å¤§æ–¼æ‹³é ­']},
                {name: 'å…¶ä»–æ°´æœ', emoji: 'ğŸ«', needsCustom: true, needsQuantity: true}
            ]
        };

        // åˆå§‹åŒ–é é¢
        function init() {
            document.getElementById('recordDate').valueAsDate = new Date();
            renderFoodSection('proteinSection', foodDatabase.protein);
            renderFoodSection('carbsSection', foodDatabase.carbs);
            renderFoodSection('veggiesSection', foodDatabase.veggies);
            renderFoodSection('fruitSection', foodDatabase.fruit);
        }

        // æ¸²æŸ“é£Ÿç‰©é¸é …
        function renderFoodSection(sectionId, foods) {
            const section = document.getElementById(sectionId);
            foods.forEach((food, index) => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                
                let portionSelector = '';
                let cookingSelector = '';
                let customInput = '';
                let quantityInput = '';
                let noteInput = '';
                
                // ä»½é‡é¸æ“‡å™¨
                if (food.portions) {
                    portionSelector = `
                        <div class="portion-selector-inner">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">ä»½é‡:</label>
                            <select id="${sectionId}_${index}_portion">
                                ${food.portions.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
                
                // çƒ¹èª¿æ–¹å¼é¸æ“‡å™¨
                if (food.cooking) {
                    cookingSelector = `
                        <div class="cooking-selector">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">çƒ¹èª¿æ–¹å¼:</label>
                            <select id="${sectionId}_${index}_cooking">
                                ${food.cooking.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
                
                // è‡ªè¨‚å“é …è¼¸å…¥æ¡†
                if (food.needsCustom) {
                    customInput = `
                        <div class="custom-input">
                            <input type="text" id="${sectionId}_${index}_custom" placeholder="è«‹å¡«å¯«å“é …..." style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px; margin-top: 8px; font-size: 14px;">
                        </div>
                    `;
                }
                
                // æ•¸é‡è¼¸å…¥æ¡†
                if (food.needsQuantity) {
                    const unit = food.quantityUnit || 'å€‹/é¡†/ç‰‡';
                    quantityInput = `
                        <div class="quantity-input">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">æ•¸é‡:</label>
                            <input type="text" id="${sectionId}_${index}_quantity" placeholder="ä¾‹: 10é¡†ã€3ç‰‡" style="width: 100%; padding: 8px; border: 2px solid #ff9800; border-radius: 5px; font-size: 14px;">
                            <small style="color: #999; font-size: 11px;">${unit}</small>
                        </div>
                    `;
                }
                
                // å‚™è¨»è¼¸å…¥æ¡†
                if (food.needsNote) {
                    noteInput = `
                        <div class="note-input">
                            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 5px;">å‚™è¨»:</label>
                            <textarea id="${sectionId}_${index}_note" placeholder="å…¶ä»–èªªæ˜..." style="width: 100%; padding: 8px; border: 2px solid #999; border-radius: 5px; font-size: 13px; min-height: 50px; resize: vertical;"></textarea>
                        </div>
                    `;
                }
                
                foodItem.innerHTML = `
                    <input type="checkbox" id="${sectionId}_${index}" onchange="toggleFood(this, '${sectionId}_${index}')">
                    <div class="food-image">${food.emoji}</div>
                    <div class="food-label">${food.name}</div>
                    <div class="portion-selector">
                        ${portionSelector}
                        ${cookingSelector}
                        ${customInput}
                        ${quantityInput}
                        ${noteInput}
                    </div>
                `;
                section.appendChild(foodItem);
            });
        }

        // åˆ‡æ›é£Ÿç‰©é¸æ“‡
        function toggleFood(checkbox, id) {
            const foodItem = checkbox.closest('.food-item');
            if (checkbox.checked) {
                foodItem.classList.add('selected');
            } else {
                foodItem.classList.remove('selected');
            }
        }

        // æ”¶é›†é¸æ“‡çš„è³‡æ–™
        function collectData() {
            const data = {
                name: document.getElementById('clientName').value,
                date: document.getElementById('recordDate').value,
                mealType: document.getElementById('mealType').value,
                locationType: document.getElementById('locationType').value,
                protein: getSelectedFoods('proteinSection', foodDatabase.protein),
                carbs: getSelectedFoods('carbsSection', foodDatabase.carbs),
                veggies: getSelectedFoods('veggiesSection', foodDatabase.veggies),
                fruit: getSelectedFoods('fruitSection', foodDatabase.fruit),
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };
            return data;
        }

        function getSelectedFoods(sectionId, foodList) {
            const selected = [];
            foodList.forEach((food, index) => {
                const checkbox = document.getElementById(`${sectionId}_${index}`);
                if (checkbox && checkbox.checked) {
                    const item = {
                        name: food.name,
                        emoji: food.emoji
                    };
                    
                    // ä»½é‡
                    const portionSelect = document.getElementById(`${sectionId}_${index}_portion`);
                    if (portionSelect) {
                        item.portion = portionSelect.value;
                    }
                    
                    // çƒ¹èª¿æ–¹å¼
                    const cookingSelect = document.getElementById(`${sectionId}_${index}_cooking`);
                    if (cookingSelect) {
                        item.cooking = cookingSelect.value;
                    }
                    
                    // è‡ªè¨‚å“é …åç¨±
                    const customInput = document.getElementById(`${sectionId}_${index}_custom`);
                    if (customInput) {
                        item.customName = customInput.value || 'æœªå¡«å¯«';
                    }
                    
                    // æ•¸é‡
                    const quantityInput = document.getElementById(`${sectionId}_${index}_quantity`);
                    if (quantityInput) {
                        item.quantity = quantityInput.value || 'æœªå¡«å¯«';
                    }
                    
                    // å‚™è¨»
                    const noteInput = document.getElementById(`${sectionId}_${index}_note`);
                    if (noteInput && noteInput.value) {
                        item.note = noteInput.value;
                    }
                    
                    selected.push(item);
                }
            });
            return selected;
        }

        // ç”Ÿæˆ PDF
        async function generatePDF() {
            const data = collectData();
            
            if (!data.name || !data.date) {
                alert('è«‹å¡«å¯«å§“åå’Œæ—¥æœŸï¼');
                return;
            }

            // å„²å­˜åˆ°æœ¬åœ°è¨˜éŒ„
            saveToHistory(data);

            // å‰µå»º PDF å…§å®¹
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // è¨­ç½®ä¸­æ–‡å­—é«”æ”¯æŒ
            doc.setFont('helvetica');
            
            let y = 20;
            
            // Fit21 å“ç‰Œ
            doc.setFontSize(16);
            doc.setTextColor(102, 126, 234);
            doc.text('Fit21', 105, y, { align: 'center' });
            y += 10;
            
            // æ¨™é¡Œ
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(20);
            doc.text('æ¯æ—¥é£²é£Ÿè‡ªæˆ‘ç›£æ§ç´€éŒ„è¡¨', 105, y, { align: 'center' });
            y += 15;
            
            // åŸºæœ¬è³‡è¨Š
            doc.setFontSize(12);
            doc.text(`å§“å: ${data.name}`, 20, y);
            doc.text(`æ—¥æœŸ: ${data.date}`, 120, y);
            y += 10;
            doc.text(`é¤åˆ¥: ${data.mealType}`, 20, y);
            doc.text(`é¡å‹: ${data.locationType}`, 120, y);
            y += 15;
            
            // è›‹ç™½è³ª
            if (data.protein.length > 0) {
                doc.setFontSize(14);
                doc.text('ä¸»è¦è›‹ç™½è³ªä¾†æº:', 20, y);
                y += 8;
                doc.setFontSize(11);
                data.protein.forEach(item => {
                    let text = `- ${item.name}`;
                    if (item.customName) {
                        text += ` (${item.customName})`;
                    }
                    if (item.portion) {
                        text += `: ${item.portion}`;
                    }
                    if (item.cooking) {
                        text += ` [${item.cooking}]`;
                    }
                    doc.text(text, 25, y);
                    y += 7;
                    if (item.note) {
                        doc.setFontSize(10);
                        doc.text(`  å‚™è¨»: ${item.note}`, 30, y);
                        y += 6;
                        doc.setFontSize(11);
                    }
                });
                y += 5;
            }
            
            // ç¢³æ°´åŒ–åˆç‰©
            if (data.carbs.length > 0) {
                doc.setFontSize(14);
                doc.text('ç¢³æ°´åŒ–åˆç‰©:', 20, y);
                y += 8;
                doc.setFontSize(11);
                data.carbs.forEach(item => {
                    let text = `- ${item.name}`;
                    if (item.customName) {
                        text += ` (${item.customName})`;
                    }
                    if (item.quantity) {
                        text += `: ${item.quantity}`;
                    } else if (item.portion) {
                        text += `: ${item.portion}`;
                    }
                    doc.text(text, 25, y);
                    y += 7;
                });
                y += 5;
            }
            
            // è”¬èœ
            if (data.veggies.length > 0) {
                doc.setFontSize(14);
                doc.text('è”¬èœæ”å–:', 20, y);
                y += 8;
                doc.setFontSize(11);
                data.veggies.forEach(item => {
                    let text = `- ${item.name}`;
                    if (item.quantity) {
                        text += `: ${item.quantity}`;
                    } else if (item.portion) {
                        text += `: ${item.portion}`;
                    }
                    doc.text(text, 25, y);
                    y += 7;
                });
                y += 5;
            }
            
            // æ°´æœ
            if (data.fruit.length > 0) {
                doc.setFontSize(14);
                doc.text('æ°´æœç´€éŒ„:', 20, y);
                y += 8;
                doc.setFontSize(11);
                data.fruit.forEach(item => {
                    let text = `- ${item.name}`;
                    if (item.customName) {
                        text += ` (${item.customName})`;
                    }
                    if (item.quantity) {
                        text += `: ${item.quantity}`;
                    } else if (item.portion) {
                        text += `: ${item.portion}`;
                    }
                    doc.text(text, 25, y);
                    y += 7;
                });
                y += 5;
            }
            
            // å‚™è¨»
            if (data.notes) {
                doc.setFontSize(14);
                doc.text('å‚™è¨»:', 20, y);
                y += 8;
                doc.setFontSize(11);
                const notesLines = doc.splitTextToSize(data.notes, 170);
                doc.text(notesLines, 25, y);
            }
            
            // å„²å­˜ PDF
            const fileName = `é£²é£Ÿç´€éŒ„_${data.name}_${data.date}.pdf`;
            doc.save(fileName);
            
            alert('PDFå·²ç”Ÿæˆï¼æ‚¨å¯ä»¥é€éä¸‹æ–¹æŒ‰éˆ•åˆ†äº«åˆ°Line');
        }

        // å„²å­˜åˆ°æ­·å²ç´€éŒ„
        function saveToHistory(data) {
            let history = JSON.parse(localStorage.getItem('dietHistory') || '[]');
            history.unshift(data);
            // åªä¿ç•™æœ€è¿‘30ç­†
            history = history.slice(0, 30);
            localStorage.setItem('dietHistory', JSON.stringify(history));
        }

        // é¡¯ç¤ºæ­·å²ç´€éŒ„
        function showHistory() {
            const history = JSON.parse(localStorage.getItem('dietHistory') || '[]');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡ç´€éŒ„</p>';
            } else {
                historyList.innerHTML = history.map(record => `
                    <div class="history-item">
                        <h3>${record.name} - ${record.date} (${record.mealType})</h3>
                        ${record.protein.length > 0 ? `<p><strong>ğŸ¥© è›‹ç™½è³ª:</strong><br>${record.protein.map(p => {
                            let text = `${p.name}`;
                            if (p.customName) text += `(${p.customName})`;
                            if (p.portion) text += ` - ${p.portion}`;
                            if (p.cooking) text += ` [${p.cooking}]`;
                            if (p.note) text += `<br>&nbsp;&nbsp;&nbsp;&nbsp;ğŸ’­ ${p.note}`;
                            return text;
                        }).join('<br>')}</p>` : ''}
                        ${record.carbs.length > 0 ? `<p><strong>ğŸš ç¢³æ°´:</strong><br>${record.carbs.map(c => {
                            let text = c.name;
                            if (c.customName) text += `(${c.customName})`;
                            if (c.quantity) text += ` - ${c.quantity}`;
                            else if (c.portion) text += ` - ${c.portion}`;
                            return text;
                        }).join('<br>')}</p>` : ''}
                        ${record.veggies.length > 0 ? `<p><strong>ğŸ¥¬ è”¬èœ:</strong><br>${record.veggies.map(v => {
                            let text = v.name;
                            if (v.quantity) text += ` - ${v.quantity}`;
                            else if (v.portion) text += ` - ${v.portion}`;
                            return text;
                        }).join('<br>')}</p>` : ''}
                        ${record.fruit.length > 0 ? `<p><strong>ğŸ æ°´æœ:</strong><br>${record.fruit.map(f => {
                            let text = f.name;
                            if (f.customName) text += `(${f.customName})`;
                            if (f.quantity) text += ` - ${f.quantity}`;
                            else if (f.portion) text += ` - ${f.portion}`;
                            return text;
                        }).join('<br>')}</p>` : ''}
                        ${record.notes ? `<p><strong>ğŸ’­ å‚™è¨»:</strong> ${record.notes}</p>` : ''}
                    </div>
                `).join('');
            }
            
            document.getElementById('historyModal').classList.add('active');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // åˆ†äº«åˆ° Line
        function shareToLine() {
            const data = collectData();
            
            if (!data.name || !data.date) {
                alert('è«‹å…ˆå¡«å¯«å§“åå’Œæ—¥æœŸï¼');
                return;
            }
            
            // ç”Ÿæˆåˆ†äº«æ–‡å­—
            let shareText = `ã€Fit21 é£²é£Ÿç´€éŒ„ã€‘\n\nğŸ“‹ é£²é£Ÿç´€éŒ„\nå§“å: ${data.name}\næ—¥æœŸ: ${data.date}\né¤åˆ¥: ${data.mealType}\n\n`;
            
            if (data.protein.length > 0) {
                shareText += `ğŸ¥© è›‹ç™½è³ª:\n${data.protein.map(p => {
                    let text = `- ${p.name}`;
                    if (p.customName) text += ` (${p.customName})`;
                    if (p.portion) text += `: ${p.portion}`;
                    if (p.cooking) text += ` [${p.cooking}]`;
                    if (p.note) text += `\n  ğŸ’­ ${p.note}`;
                    return text;
                }).join('\n')}\n\n`;
            }
            if (data.carbs.length > 0) {
                shareText += `ğŸš ç¢³æ°´:\n${data.carbs.map(c => {
                    let text = `- ${c.name}`;
                    if (c.customName) text += ` (${c.customName})`;
                    if (c.quantity) text += `: ${c.quantity}`;
                    else if (c.portion) text += `: ${c.portion}`;
                    return text;
                }).join('\n')}\n\n`;
            }
            if (data.veggies.length > 0) {
                shareText += `ğŸ¥¬ è”¬èœ:\n${data.veggies.map(v => {
                    let text = `- ${v.name}`;
                    if (v.quantity) text += `: ${v.quantity}`;
                    else if (v.portion) text += `: ${v.portion}`;
                    return text;
                }).join('\n')}\n\n`;
            }
            if (data.fruit.length > 0) {
                shareText += `ğŸ æ°´æœ:\n${data.fruit.map(f => {
                    let text = `- ${f.name}`;
                    if (f.customName) text += ` (${f.customName})`;
                    if (f.quantity) text += `: ${f.quantity}`;
                    else if (f.portion) text += `: ${f.portion}`;
                    return text;
                }).join('\n')}\n\n`;
            }
            if (data.notes) {
                shareText += `ğŸ’­ å‚™è¨»: ${data.notes}`;
            }
            
            // ä½¿ç”¨ Line åˆ†äº« API
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(shareText)}`;
            window.open(lineUrl, '_blank');
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>
